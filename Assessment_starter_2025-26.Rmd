---
title: "Assessment starter - 2025-26"
author: "Kasia Banas"
date: "2025-10-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data introduction

For the assessment, you will be working with data about prescriptions in the community in Scotland. These data show you all medicines that have been dispensed to people by pharmacies in the community. There is a separate data set for each month, from October 2015.

You can find the data and the data dictionary here:

<https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community>

## Focus on the July 2025 file

Create a GitHub repo for this week (if you haven't already) and clone it to create a new project within your RStudio. Create a `data` subfolder within your Week07 folder.

We'll focus on the July 2025 file, as that includes the most recent data. You can find the file here:

<https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community/resource/12448904-f11c-4a0f-8dab-8b47c5abebf8>

For a glossary of terms (variable names), go to <https://publichealthscotland.scot/publications/monthly-prescribing-activity-data/monthly-prescribing-activity-data-data-for-july-2025/>

Read through the glossary (Appendix A1 of the Open data glossary of terms) to make sure that you understand the variables.

Let's download the data and load it into RStudio (note that the file has over 1 million rows - things are starting to get big here, and the download from the website will take over a minute). If you struggle to download from the website, you can find this file on Learn as well.

We'll use the `clean_names()` function from the `janitor` library to have uniform names in all files we upload today.

```{r warning=FALSE}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure (will be useful later)

data_july2025 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/12448904-f11c-4a0f-8dab-8b47c5abebf8/download/pitc202507.csv") %>% 
  clean_names()

```

## Exercise 1

Find out the 10 most prescribed medicines in Scotland, in July 2025. Use the `paid_quantity` variable as your outcome. Produce a table. Start with a simple table; make it pretty if you have time at the end.

```{r}
paid_quantity<-data_july2025 %>% 
  select(paid_quantity) %>% 
  arrange (desc(paid_quantity)) %>% 
  slice (1:10)
```

## Exercise 2

Load in the health board names data set from the PHS Open Data website and `clean_names`. Perform a join of this and the prescriptions dataset, so you can see names of health boards.

Location of the dataset and data dictionary: <https://www.opendata.nhs.scot/dataset/geography-codes-and-labels/resource/652ff726-e676-4a20-abda-435b98dd7bdc>

```{r}
health_board_data <- read.csv ("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
clean_names()

joined_pres_hbdata <- full_join(data_july2025,health_board_data, by = c("hbt"= "hb"))
```

## Exercise 3

There are some rows where the hb_name has a missing value - find those rows (best save them into a new object), eyeball them and see what's going on (HINT: Check the information available at <https://www.opendata.nhs.scot/dataset/non-standard-geography-codes-and-labels/resource/0450a5a2-f600-4569-a9ae-5d6317141899>).

```{r}
filtered_joined <- joined_pres_hbdata %>% 
  filter (is.na(hb_name))

```

## Interlude

Copy the file `UV102a_age_health_board_census.csv` into your `data` subfolder within the `Week07` folder. The code below reads in and cleans a data file from the 2022 census, showing the population in each health board, broken up by age and sex.

Open the file in Excel to see what's in there. Then, read the code below, make sure you understand it, and run the code chunk:

Note: Make sure you have a data folder where the file is located.

```{r}

population_data <- read_csv(here( "data", "UV102a_age_health_board_census.csv"), skip = 10) %>% 
  # Rename the last column to avoid the messy name in column 6
  # and to match column names with the prescription dataset
  #Spare= new name
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  # filter the data so that we get the population of the entire health board
  filter(Age == "All people" & Sex == "All people") %>% 
  # select only the relevant columns
  select(hb_name, hb_population) %>% 
  # change health board names so they match the prescription data
  mutate(hb_name = paste("NHS", hb_name))

```

Check the resulting dataframe. Don't worry about the warning - it has to do with how the census tables are structured.

## Exercise 4

Join the `population_data` object with your joined data, so you can see the population of each healthboard.

```{r}
hb_population_data <- left_join (joined_pres_hbdata,population_data, by = c("hb_name" = "hb_name"))
```

## Exercise 5

Study and then run the code below. It introduces a couple of new functions that you may find useful. If anything is unclear, run ?function_name, or ask us.

```{r}
#str_detect - detect the presence/absence of a match
paracetamol_data <- hb_population_data %>% 
  filter(str_detect(bnf_item_description, "PARACET")) %>% 
  group_by(hb_name, bnf_item_description) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  slice_max(paid_quantity, n = 3) 
# notice the performance of the slice_max function on a grouped tibble
```

## Exercise 6

As you have discovered, paracetamol is dispensed either as capsules/caplets or as an oral suspension. For each health board, calculate the number of capsules/caplets dispensed in July 2025 per person living in that health board. Plot your findings as a bar chart. Can you order the bars so that they appear in a decreasing order?

```{r}
paracetamol_caps_oral <- paracetamol_data %>% 
  filter(str_detect(bnf_item_description, "CAP")) %>% 
  group_by(hb_name) %>% 
  summarise(paid_quantity = sum(paid_quantity))
  
paracetamol_caps_oral %>%   
  ggplot(aes(x= paid_quantity, y= reorder(hb_name, paid_quantity))) + 
  geom_col() +
  labs (x= "paid quantity", y= "health boards" ) +
  theme(axis.text.x = element_text (angle =90, vjust = 0.5, hjust=1))

#for bar chart = use geom_col (), instead geom_bar
# because we already move to 90 deg, hjust = horizontal movements of the word : closer to the chart, vjust =vertical
```

## Exercise 7

Pick a month from the peak of the pandemic, when people perhaps were less likely to venture out to the pharmacy for paracetamol. Find and download the appropriate file from the website, and then load it into R. Calculate and plot the number of paracetamol tablets/caplets dispensed per person in each health board in that month. Arrange your two graphs together using `patchwork()`.

NOTE: The names of paracetamol items changed in early 2023. You'll need to check what the naming convention was before then.

NOTE: There's no need to split tablets and capsules into separate groups.

Look closely at the two graphs and see what could be done to make them more easily comparable. Implement your ideas. Then think about how you could combine the graphs using faceting rather than patchwork. If you have time, try and implement this method (or come back to it later).

```{r}
pandemic_para_data <-read.csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/83bf4892-d246-41f8-a6ca-d44d18e2a2ca/download/pitc202010.csv")
```

## Exercise 8

Download data files from 6 consecutive months from the website: July - December 2022. Put them into a folder called consecutive_data inside the data folder. Then, run the code below to load the data in and put them all into one data frame:

```{r}
files <- list.files(here("data", "consecutive_data"), pattern = "csv")

consecutive_data <- files %>% 
  map_dfr(~read_csv(here("data", "consecutive_data", .)))
```

## Exercise 9

Find the number of paracetamol capsules/caplets dispensed per person in each health board, in each of the consecutive months. Plot the result as a line chart. What patterns do you see? Which health board has dispensed the most paracetamol? And which one the least?

```{r}

```
